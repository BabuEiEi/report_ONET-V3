<script>
  // ==========================================
  // 1. CONFIGURATION & VARIABLES
  // ==========================================
  let currentUser = {};
  let currentConfig = {};
  let currentTableData = []; 
  let currentRowIndex = null; 
  let currentMenu = null;
  let isSidebarCollapsed = false;
  let operationMode = ''; 
  let DATA_CACHE = {}; 

  // --- COLUMN CONFIGURATION ---
  const COLUMN_CONFIG = {
    'SchoolInfo': [
      { key: 'school_id', label: '‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', readonly: true }, { key: 'school_name', label: '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' }, { key: 'province', label: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' },
      { key: 'district', label: '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠' }, { key: 'affiliation', label: '‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î' }, { key: 'director_name', label: '‡∏ä‡∏∑‡πà‡∏≠ ‡∏ú‡∏≠.' },
      { key: 'director_phone', label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡∏ú‡∏≠.' }, { key: 'coord_name', label: '‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô' }, { key: 'coord_phone', label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠' }
    ],
    'FieldDetails': [
      { key: 'school_id', label: '‡∏£‡∏´‡∏±‡∏™', readonly: true }, { key: 'school_name', label: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', readonly: true },
      { key: 'total_eligible', label: '‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö' }, { key: 'total_rooms', label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö' },
      { key: 'round1_seats', label: '‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏£‡∏≠‡∏ö 1' }, { key: 'round1_rooms', label: '‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ö 1' },
      { key: 'round2_seats', label: '‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏£‡∏≠‡∏ö 2' }, { key: 'round2_rooms', label: '‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ö 2' },
      { key: 'round3_seats', label: '‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏£‡∏≠‡∏ö 3' }, { key: 'round3_rooms', label: '‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ö 3' },
      { key: 'round4_seats', label: '‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏£‡∏≠‡∏ö 4' }, { key: 'round4_rooms', label: '‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ö 4' }
    ],
    'RoomDetails': [
      { key: 'school_id', label: '‡∏£‡∏´‡∏±‡∏™', readonly: true }, { key: 'school_name', label: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', readonly: true },
      { key: 'room_seq', label: '‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á' }, { key: 'room_name', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á' }, { key: 'max_seats', label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î' },
      { key: 'round1_seats', label: '‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏£‡∏≠‡∏ö 1' }, { key: 'round2_seats', label: '‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏£‡∏≠‡∏ö 2' },
      { key: 'round3_seats', label: '‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏£‡∏≠‡∏ö 3' }, { key: 'round4_seats', label: '‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏£‡∏≠‡∏ö 4' }
    ],
    'BudgetDetails': [
      { key: 'school_id', label: '‡∏£‡∏´‡∏±‡∏™', readonly: true }, { key: 'school_name', label: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', readonly: true },
      { key: 'head_exam_pay', label: '‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤' }, { key: 'coord_pay', label: '‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô' },
      { key: 'meeting_head', label: '‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤' }, { key: 'meeting_coord', label: '‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô' },
      { key: 'total_budget', label: '‡∏£‡∏ß‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì' }, { key: 'bank_account_name', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ' }, { key: 'bank_account_number', label: '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ' }
    ],
    'Users': [
      { key: 'ref_id', label: '‡∏£‡∏´‡∏±‡∏™ (Ref ID)', readonly: true }, { key: 'display_name', label: '‡∏ä‡∏∑‡πà‡∏≠/‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' },
      { key: 'username', label: 'Username' }, { key: 'password', label: 'Password' },
      { key: 'role', label: '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Dropdown)' }, { key: 'status', label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Active/Inactive)' }
    ],
    'Documents': [
      { key: 'doc_id', label: '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' }, { key: 'doc_name', label: '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' },
      { key: 'category', label: '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' }, { key: 'link_url', label: '‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå URL' }, { key: 'target_role', label: '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡πá‡∏ô' }
    ],
    'Setting': [
      { key: 'setting_key', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', readonly: true }, { key: 'setting_value', label: '‡∏Ñ‡πà‡∏≤' }, { key: 'description', label: '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢' }
    ]
  };

  const MENUS = [
    { id: 'home', label: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', icon: 'fa-school', table: 'SchoolInfo', viewType: 'table' },
    { id: 'field', label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö', icon: 'fa-building', table: 'FieldDetails', viewType: 'table' },
    { id: 'room', label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö', icon: 'fa-desktop', table: 'RoomDetails', viewType: 'table' },
    { id: 'budget', label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', icon: 'fa-money-bill-wave', table: 'BudgetDetails', viewType: 'table' },
    { id: 'docs', label: '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£/‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠', icon: 'fa-file-pdf', table: 'Documents', viewType: 'table' },
  ];
  
  const ADMIN_MENUS = [
     { id: 'users', label: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', icon: 'fa-users-cog', table: 'Users', viewType: 'table' },
     { id: 'setting', label: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö', icon: 'fa-cogs', table: 'Setting', viewType: 'card' }
  ];

  function handleLogin(e) {
    e.preventDefault(); toggleLoader(true);
    google.script.run.withSuccessHandler(res => {
      toggleLoader(false);
      if (res.status === true) { currentUser = res.user; currentConfig = res.config; initDashboard(); } 
      else { Swal.fire({ icon: 'error', title: 'Login Failed', text: res.msg }); }
    }).apiLogin(document.getElementById('username').value, document.getElementById('password').value);
  }

  function logout() {
    Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?', icon: 'question', showCancelButton: true }).then((r) => {
      if (r.isConfirmed) {
        document.getElementById('page-dashboard').classList.add('hidden');
        document.getElementById('page-login').classList.remove('hidden');
        document.getElementById('password').value = '';
        DATA_CACHE = {}; 
      }
    });
  }

  function initDashboard() {
    document.getElementById('page-login').classList.add('hidden');
    document.getElementById('page-dashboard').classList.remove('hidden');
    document.getElementById('user-name').innerText = currentUser.display_name;
    document.getElementById('user-role').innerText = currentUser.role.toUpperCase();
    if (currentConfig.logo) document.querySelectorAll('#nav-logo').forEach(el => { el.src = currentConfig.logo; el.classList.remove('hidden'); });
    renderMenu();
    
    // Client-side URL param check
    const urlParams = new URLSearchParams(window.location.search);
    const page = urlParams.get('page') || 'home';
    let targetMenu = [...MENUS, ...ADMIN_MENUS].find(m => m.id === page);
    if (currentUser.role !== 'admin' && ADMIN_MENUS.some(m => m.id === page)) targetMenu = MENUS[0];
    loadContent(targetMenu || MENUS[0]);
  }

  function renderMenu() {
    const list = document.getElementById('menu-list'); list.innerHTML = '';
    let items = [...MENUS]; if (currentUser.role === 'admin') items = [...items, ...ADMIN_MENUS];
    const baseUrl = window.location.href.split('?')[0]; 
    items.forEach(item => {
      const li = document.createElement('li');
      li.innerHTML = `<a href="${baseUrl}?page=${item.id}" class="sidebar-link flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-700 rounded-lg transition duration-200"><div class="w-8 text-center flex-shrink-0"><i class="fas ${item.icon} text-lg"></i></div><span class="ml-3 font-medium sidebar-text overflow-hidden whitespace-nowrap">${item.label}</span></a>`;
      li.querySelector('a').addEventListener('click', (e) => { if (e.button === 0 && !e.ctrlKey && !e.metaKey) { e.preventDefault(); loadContent(item); } });
      list.appendChild(li);
    });
  }

  function toggleSidebar() {
    isSidebarCollapsed = !isSidebarCollapsed;
    const sidebar = document.getElementById('sidebar');
    if (isSidebarCollapsed) { sidebar.classList.remove('w-64'); sidebar.classList.add('w-20', 'hide-text'); } 
    else { sidebar.classList.remove('w-20', 'hide-text'); sidebar.classList.add('w-64'); }
    setTimeout(() => { if($.fn.DataTable.isDataTable('#dataTableID')) $('#dataTableID').DataTable().columns.adjust().responsive.recalc(); }, 300);
  }

  // ==========================================
  // 3. CONTENT LOADING
  // ==========================================
  function loadContent(menuItem, forceRefresh = false) {
    toggleLoader(true);
    currentMenu = menuItem;
    document.getElementById('page-title').innerText = menuItem.label;
    
    document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('bg-blue-100', 'text-blue-700', 'font-bold'));
    const activeLink = Array.from(document.querySelectorAll('.sidebar-link')).find(el => el.href.includes(`page=${menuItem.id}`));
    if(activeLink) activeLink.classList.add('bg-blue-100', 'text-blue-700', 'font-bold');

    document.getElementById('content-area').classList.add('hidden');
    document.getElementById('card-area').classList.add('hidden');
    
    const btnAdd = document.getElementById('btn-add-data');
    if (currentUser.role === 'admin' && ['Documents', 'Users', 'Setting'].includes(menuItem.table)) {
       btnAdd.classList.remove('hidden'); btnAdd.classList.add('flex');
    } else {
       btnAdd.classList.add('hidden'); btnAdd.classList.remove('flex');
    }

    // SPECIAL: Budget Page
    if (currentUser.role === 'school' && menuItem.id === 'budget') {
        google.script.run
            .withSuccessHandler(bundle => {
                toggleLoader(false);
                document.getElementById('content-area').classList.remove('hidden');
                renderBudgetDetailsOfficial(bundle.budget || {}, bundle.field || {}); 
            })
            .withFailureHandler(err => { toggleLoader(false); Swal.fire('Error', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); })
            .apiGetSchoolBudgetBundle(currentUser.ref_id);
        return;
    }

    if (!forceRefresh && DATA_CACHE[menuItem.table]) { processAndRender(DATA_CACHE[menuItem.table], menuItem); return; }

    google.script.run.withSuccessHandler(rawData => {
      toggleLoader(false);
      let filteredData = (rawData || []).filter(row => {
          if(!row) return false;
          const k = Object.keys(row).find(x => x !== '_rowIndex');
          return row[k] && String(row[k]).trim() !== '';
      });
      DATA_CACHE[menuItem.table] = filteredData;
      processAndRender(filteredData, menuItem);
    }).apiGetData(menuItem.table, currentUser.role, currentUser.ref_id);
  }

  function processAndRender(data, menuItem) {
      currentTableData = data; 
      toggleLoader(false);

      if (currentUser.role === 'school' && menuItem.id === 'home') {
          document.getElementById('content-area').classList.remove('hidden');
          renderSchoolProfile(data[0] || {}); 
      } 
      else if (currentUser.role === 'school' && menuItem.id === 'field') {
          document.getElementById('content-area').classList.remove('hidden');
          renderFieldDetails(data[0] || {});
      }
      else if (currentUser.role === 'school' && menuItem.id === 'room') {
          document.getElementById('content-area').classList.remove('hidden');
          renderRoomDetails(data || []); 
      }
      // *** DOCUMENTS VIEW ***
      else if (menuItem.id === 'docs') {
          document.getElementById('content-area').classList.remove('hidden');
          renderDocumentList(data || []); 
      }
      else if (menuItem.viewType === 'table') {
        document.getElementById('content-area').classList.remove('hidden');
        renderTable(menuItem, data || []);
      } else {
        document.getElementById('card-area').classList.remove('hidden');
        renderCards(menuItem, data || []);
      }
  }

  function formatMoney(amount) {
      if (!amount || amount === '-') return '0.00';
      let num = parseFloat(String(amount).replace(/,/g, ''));
      return isNaN(num) ? '0.00' : num.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function formatNum(num) { return num ? num : '0'; }

  // ==========================================
  // RENDER FUNCTIONS
  // ==========================================

  // --- üü¢ 1. DOCUMENTS LIST (V1 Style: Compact Rows) ---
  function renderDocumentList(data) {
    const div = document.getElementById('content-area');
    
    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (!data || data.length === 0) { 
        div.innerHTML = `<div class="text-center py-12 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl"><div class="text-gray-400 mb-2"><i class="fas fa-file-invoice text-4xl"></i></div><p class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì</p></div>`; 
        return; 
    }

    let html = `
      <div class="max-w-5xl mx-auto mt-4 font-sarabun pb-10">
        <div class="flex justify-between items-center mb-6">
           <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-folder-open text-pink-500 mr-2"></i> ‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</h3>
        </div>
        <div class="space-y-3">`;

    data.forEach(doc => {
        let deleteBtn = '';
        if(currentUser.role === 'admin') {
            deleteBtn = `<button onclick="deleteItem(${doc._rowIndex})" class="text-gray-400 hover:text-red-500 ml-4 transition p-2" title="‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"><i class="fas fa-trash-alt"></i></button>`;
        }

        html += `
            <div class="flex justify-between items-center p-4 bg-white border border-gray-200 rounded-lg hover:shadow-md transition duration-200">
                <div class="flex gap-4 items-center overflow-hidden">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-pink-50 flex items-center justify-center text-pink-500">
                      <i class="fas fa-file-alt text-xl"></i>
                    </div>
                    <div class="min-w-0">
                        <div class="font-bold text-gray-800 text-base truncate pr-2">${doc.doc_name}</div>
                        <div class="flex gap-2 mt-0.5">
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded border border-gray-200">${doc.category}</span>
                            <span class="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100">For: ${doc.target_role}</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center flex-shrink-0 ml-2">
                    <a href="${doc.link_url}" target="_blank" class="flex items-center gap-2 bg-white text-blue-600 border border-blue-600 px-3 py-1.5 rounded text-sm hover:bg-blue-600 hover:text-white transition font-medium shadow-sm">
                        <i class="fas fa-download"></i> <span class="hidden sm:inline">Download</span>
                    </a>
                    ${deleteBtn}
                </div>
            </div>`;
    });

    html += `</div></div>`;
    div.innerHTML = html;
  }

  // --- 2. SCHOOL PROFILE ---
  function renderSchoolProfile(data) {
    const div = document.getElementById('content-area');
    if (!data || Object.keys(data).length === 0) { div.innerHTML = `<div class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`; return; }
    const profileFields = [{ key: 'school_id', label: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' }, { key: 'school_name', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' }, { key: 'director_name', label: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö' }, { key: 'director_phone', label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö' }, { key: 'coord_name', label: '‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô' }, { key: 'coord_phone', label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô' }];
    let html = `<div class="max-w-4xl mx-auto bg-white rounded-xl overflow-hidden shadow-lg border border-gray-200 mt-6"><div class="bg-blue-600 px-6 py-4 flex justify-between items-center"><h3 class="text-white text-lg font-bold flex items-center"><i class="fas fa-university mr-3"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3><button onclick="editItem(${data._rowIndex})" class="text-white bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded-lg text-sm transition shadow-sm border border-blue-500"><i class="fas fa-edit mr-1"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div><div class="p-6"><table class="w-full border-collapse"><tbody>`;
    profileFields.forEach((field, index) => { const val = data[field.key] || '-'; const bgClass = index % 2 === 0 ? 'bg-gray-50' : 'bg-white'; html += `<tr class="border-b border-gray-100 hover:bg-blue-50 transition ${bgClass}"><td class="px-6 py-4 w-1/3 text-gray-600 font-semibold text-sm border-r border-gray-100">${field.label}</td><td class="px-6 py-4 text-gray-800 font-medium text-sm">${val}</td></tr>`; });
    html += `</tbody></table></div></div>`;
    div.innerHTML = html;
  }

  // --- 3. FIELD DETAILS ---
  function renderFieldDetails(data) {
    const div = document.getElementById('content-area');
    if (!data || Object.keys(data).length === 0) { div.innerHTML = `<div class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö</div>`; return; }
    const roundsDetail = `${data.total_round || 0} ‡∏£‡∏≠‡∏ö (${data.detail_round || '-'})`;
    const roomsDetail = `${data.total_rooms || 0} ‡∏´‡πâ‡∏≠‡∏á <span class="text-xs text-gray-500 ml-2">(‡∏£‡∏≠‡∏ö1: ${data.round1_rooms || 0}, ‡∏£‡∏≠‡∏ö2: ${data.round2_rooms || 0}, ‡∏£‡∏≠‡∏ö3: ${data.round3_rooms || 0}, ‡∏£‡∏≠‡∏ö4: ${data.round4_rooms || 0})</span>`;
    let html = `<div class="max-w-5xl mx-auto space-y-6 mt-4"><div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden"><div class="bg-indigo-600 px-6 py-3 border-b border-indigo-700"><h3 class="text-white font-bold text-lg"><i class="fas fa-building mr-2"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö</h3></div><div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-indigo-50 p-4 rounded-lg"><p class="text-sm text-gray-500 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</p><p class="text-xl font-bold text-indigo-900">${roundsDetail}</p></div><div class="bg-blue-50 p-4 rounded-lg"><p class="text-sm text-gray-500 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö</p><p class="text-xl font-bold text-blue-900">${roomsDetail}</p></div><div class="bg-green-50 p-4 rounded-lg"><p class="text-sm text-gray-500 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö</p><p class="text-xl font-bold text-green-900">${data.total_eligible || 0} ‡∏Ñ‡∏ô</p></div><div class="bg-orange-50 p-4 rounded-lg"><p class="text-sm text-gray-500 mb-1">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p><p class="text-md font-bold text-orange-900">${data.school_test || '-'}</p></div></div></div><div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden"><div class="bg-teal-600 px-6 py-3 border-b border-teal-700"><h3 class="text-white font-bold text-lg"><i class="fas fa-users mr-2"></i> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</h3></div><div class="p-0"><table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-6 py-3">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th><th class="px-6 py-3 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Ñ‡∏ô)</th></tr></thead><tbody class="divide-y divide-gray-100"><tr class="hover:bg-gray-50"><td class="px-6 py-3 font-medium">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö</td><td class="px-6 py-3 text-right">${data.head || 0}</td></tr><tr class="hover:bg-gray-50"><td class="px-6 py-3 font-medium">‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö</td><td class="px-6 py-3 text-right">${data.coord || 0}</td></tr><tr class="hover:bg-gray-50"><td class="px-6 py-3 font-medium">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö</td><td class="px-6 py-3 text-right">${data.system_admin || 0}</td></tr><tr class="hover:bg-gray-50"><td class="px-6 py-3 font-medium">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö</td><td class="px-6 py-3 text-right">${data.system_roomy || 0}</td></tr><tr class="hover:bg-gray-50"><td class="px-6 py-3 font-medium">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö</td><td class="px-6 py-3 text-right">${data.proctor || 0}</td></tr><tr class="hover:bg-gray-50"><td class="px-6 py-3 font-medium">‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏£‡πÇ‡∏£‡∏á</td><td class="px-6 py-3 text-right">${data.janitor || 0}</td></tr><tr class="bg-teal-50 font-bold text-teal-800"><td class="px-6 py-3">‡∏£‡∏ß‡∏°‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td><td class="px-6 py-3 text-right">${data.total_comme || 0}</td></tr></tbody></table></div></div><div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden"><div class="px-6 py-4 flex items-start"><div class="p-3 bg-yellow-100 text-yellow-600 rounded-full mr-4"><i class="fas fa-school"></i></div><div><h4 class="text-gray-900 font-bold text-md">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö</h4><p class="text-gray-600 mt-1">${data.proctor_name || '-'}</p></div></div></div></div>`;
    div.innerHTML = html;
  }

  // --- 4. ROOM DETAILS ---
  function renderRoomDetails(data) {
    const div = document.getElementById('content-area');
    if (!data || data.length === 0) { div.innerHTML = `<div class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö</div>`; return; }
    let totalR1 = 0, totalR2 = 0, totalR3 = 0, totalR4 = 0;
    let rowsHtml = '';
    data.forEach((row, index) => {
        const r1 = parseInt(row.round1_seats) || 0; const r2 = parseInt(row.round2_seats) || 0; const r3 = parseInt(row.round3_seats) || 0; const r4 = parseInt(row.round4_seats) || 0;
        totalR1 += r1; totalR2 += r2; totalR3 += r3; totalR4 += r4;
        const bgClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        rowsHtml += `<tr class="${bgClass} border-b border-gray-200 hover:bg-purple-50 transition text-gray-700"><td class="px-6 py-4 font-bold text-center border-r border-gray-200">${row.room_seq}</td><td class="px-6 py-4 text-center border-r border-gray-100">${formatNum(row.round1_seats)}</td><td class="px-6 py-4 text-center border-r border-gray-100">${formatNum(row.round2_seats)}</td><td class="px-6 py-4 text-center border-r border-gray-100">${formatNum(row.round3_seats)}</td><td class="px-6 py-4 text-center">${formatNum(row.round4_seats)}</td></tr>`;
    });
    const grandTotal = totalR1 + totalR2 + totalR3 + totalR4;
    let html = `<div class="max-w-6xl mx-auto mt-6"><div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden"><div class="bg-purple-600 px-6 py-4 border-b border-purple-700 flex justify-between items-center"><h3 class="text-white text-lg font-bold"><i class="fas fa-desktop mr-2"></i> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö</h3><span class="bg-purple-500 text-white text-xs px-2 py-1 rounded">‡∏£‡∏ß‡∏° ${data.length} ‡∏´‡πâ‡∏≠‡∏á</span></div><div class="overflow-x-auto"><table class="w-full text-sm"><thead class="text-xs text-gray-600 uppercase bg-gray-100 border-b border-gray-300"><tr><th class="px-6 py-3 text-center w-24 border-r border-gray-300">‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà</th><th class="px-6 py-3 text-center border-r border-gray-200">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á (‡∏£‡∏≠‡∏ö 1)</th><th class="px-6 py-3 text-center border-r border-gray-200">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á (‡∏£‡∏≠‡∏ö 2)</th><th class="px-6 py-3 text-center border-r border-gray-200">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á (‡∏£‡∏≠‡∏ö 3)</th><th class="px-6 py-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á (‡∏£‡∏≠‡∏ö 4)</th></tr></thead><tbody>${rowsHtml}<tr class="bg-gray-800 text-white font-bold border-t-2 border-purple-500 text-base"><td class="px-6 py-4 text-center border-r border-gray-600">‡∏£‡∏ß‡∏°</td><td class="px-6 py-4 text-center border-r border-gray-600 text-yellow-300">${totalR1}</td><td class="px-6 py-4 text-center border-r border-gray-600 text-yellow-300">${totalR2}</td><td class="px-6 py-4 text-center border-r border-gray-600 text-yellow-300">${totalR3}</td><td class="px-6 py-4 text-center border-r border-gray-600 text-yellow-300">${totalR4}</td></tr></tbody></table></div></div><div class="mt-4 text-right"><button onclick="window.print()" class="text-gray-500 hover:text-gray-800 text-sm transition flex items-center justify-end w-full"><i class="fas fa-print mr-1"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button></div></div>`;
    div.innerHTML = html;
  }

  // --- 5. BUDGET DETAILS (OFFICIAL) ---
  function renderBudgetDetailsOfficial(budget, field) {
    const div = document.getElementById('content-area');
    const items = [
        { name: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö', count: field.head, meet: budget.meeting_head, work: budget.head_exam_pay },
        { name: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô', count: field.coord, meet: budget.meeting_coord, work: budget.coord_pay },
        { name: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö', count: field.system_admin, meet: budget.meeting_system_admin, work: budget.system_admin_pay },
        { name: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö', count: field.system_roomy, meet: budget.meeting_system_room, work: budget.system_room_pay },
        { name: '‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö', count: field.proctor, meet: budget.meeting_proctor, work: budget.proctor_pay },
        { name: '‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏£‡πÇ‡∏£‡∏á', count: field.janitor, meet: budget.meeting_janitor, work: budget.janitor_pay },
    ];
    let totalCount = 0, totalMeet = 0, totalWork = 0, tableRows = '';
    items.forEach((item, index) => {
        let c = parseFloat(String(item.count || 0).replace(/,/g,'')) || 0;
        let m = parseFloat(String(item.meet || 0).replace(/,/g,'')) || 0;
        let w = parseFloat(String(item.work || 0).replace(/,/g,'')) || 0;
        totalCount += c; totalMeet += m; totalWork += w;
        const bgClass = index % 2 === 0 ? 'bg-green-50/30' : 'bg-white';
        tableRows += `<tr class="${bgClass} border-b border-green-100 hover:bg-green-100 transition text-gray-700"><td class="px-4 py-3 font-medium border-r border-green-200">${item.name}</td><td class="px-4 py-3 text-center border-r border-green-200">${formatNum(item.count)}</td><td class="px-4 py-3 text-right border-r border-green-200">${formatMoney(m)}</td><td class="px-4 py-3 text-right">${formatMoney(w)}</td></tr>`;
    });
    const facility = formatMoney(budget.facility_cost);
    const documentCost = formatMoney(budget.document_cost);
    const totalEligible = formatNum(field.total_eligible);
    const totalBudget = formatMoney(budget.total_budget);
    const bankName = budget.bank_account_name || '-';
    const bankNum = budget.bank_account_number || '-';

    let html = `
      <div class="max-w-5xl mx-auto p-8 bg-white rounded-xl shadow-lg font-sarabun print-area">
        <div class="mb-8"><h3 class="text-xl font-bold text-gray-800 mb-4">1. ‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö</h3><div class="overflow-hidden rounded-lg border border-green-300"><table class="w-full text-sm"><thead><tr class="bg-[#4CAF50] text-white text-center"><th class="px-4 py-3 font-medium border-r border-green-400 w-1/3">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th><th class="px-4 py-3 font-medium border-r border-green-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô(‡∏Ñ‡∏ô)</th><th class="px-4 py-3 font-medium border-r border-green-400">‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th><th class="px-4 py-3 font-medium">‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô<br>‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</th></tr></thead><tbody>${tableRows}<tr class="bg-[#C8E6C9] text-gray-800 font-bold border-t-2 border-green-400"><td class="px-4 py-3 border-r border-green-400">‡∏£‡∏ß‡∏°</td><td class="px-4 py-3 text-center border-r border-green-400">${formatNum(totalCount)}</td><td class="px-4 py-3 text-right border-r border-green-400">${formatMoney(totalMeet)}</td><td class="px-4 py-3 text-right">${formatMoney(totalWork)}</td></tr></tbody></table></div></div>
        <div class="mb-6"><h3 class="text-lg font-bold text-gray-800 inline-block mr-2">2. ‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö</h3><div class="ml-6 mt-1 text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì <span class="font-bold text-xl mx-2 underline decoration-dotted text-green-700">${facility}</span> ‡∏ö‡∏≤‡∏ó</div></div>
        <div class="mb-10"><h3 class="text-lg font-bold text-gray-800 inline-block mr-2">3. ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ö)</h3><div class="ml-6 mt-1 text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì <span class="font-bold text-xl mx-2 underline decoration-dotted text-orange-700">${documentCost}</span> ‡∏ö‡∏≤‡∏ó</div></div>
        <div><h3 class="text-xl font-bold text-gray-800 mb-4">4. ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö</h3><div class="overflow-hidden rounded-lg border border-orange-300"><table class="w-full text-sm text-center"><thead><tr class="bg-[#ED7D31] text-white"><th class="px-4 py-3 font-medium border-r border-orange-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö</th><th class="px-4 py-3 font-medium border-r border-orange-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£</th><th class="px-4 py-3 font-medium border-r border-orange-400">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th class="px-4 py-3 font-medium">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th></tr></thead><tbody><tr class="bg-[#FCE4D6] text-gray-900"><td class="px-4 py-4 font-bold border-r border-orange-300">${totalEligible}</td><td class="px-4 py-4 font-bold border-r border-orange-300">${totalBudget}</td><td class="px-4 py-4 border-r border-orange-300">${bankName}</td><td class="px-4 py-4 font-mono font-bold">${bankNum}</td></tr></tbody></table></div></div>
        <div class="text-right pt-8 mt-8 border-t border-gray-200"><button onclick="window.print()" class="bg-gray-800 hover:bg-gray-900 text-white px-5 py-2 rounded shadow transition text-sm flex items-center inline-flex"><i class="fas fa-print mr-2"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button></div>
      </div>`;
    div.innerHTML = html;
  }

  // --- 6. STANDARD TABLE ---
  function renderTable(menuItem, data) {
    const div = document.getElementById('content-area');
    if (!data || data.length === 0) { div.innerHTML = `<div class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`; return; }
    const config = COLUMN_CONFIG[menuItem.table] || Object.keys(data[0]).filter(k => k !== '_rowIndex').map(k => ({ key: k, label: k }));
    let html = `<div class="p-4"><table id="dataTableID" class="stripe hover row-border order-column nowrap w-full text-sm" style="width:100%"><thead><tr>`;
    config.forEach(col => html += `<th>${col.label}</th>`);
    let allowEdit = (currentUser.role === 'admin' || (currentUser.role === 'school' && ['SchoolInfo','BudgetDetails'].includes(menuItem.table)));
    if (currentUser.role === 'school' && (menuItem.table === 'SchoolInfo' || menuItem.table === 'FieldDetails' || menuItem.table === 'RoomDetails' || menuItem.table === 'BudgetDetails')) allowEdit = false;
    if (allowEdit) html += `<th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>`;
    html += `</tr></thead><tbody>`;
    data.forEach(row => {
      html += `<tr>`;
      config.forEach(col => {
         let val = row[col.key] || '-';
         if(String(val).startsWith('http')) val = `<a href="${val}" target="_blank" class="text-blue-500"><i class="fas fa-external-link-alt"></i></a>`;
         if(col.key === 'status') val = (val === 'Active') ? '<span class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">Active</span>' : '<span class="px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">Inactive</span>';
         html += `<td>${val}</td>`;
      });
      if (allowEdit) {
        const deleteBtn = (currentUser.role === 'admin') ? `<button onclick="deleteItem(${row._rowIndex})" class="text-red-500 hover:text-red-700 p-2 rounded-full transition transform hover:scale-110 ml-1"><i class="fas fa-trash"></i></button>` : '';
        html += `<td class="text-center whitespace-nowrap"><button onclick="editItem(${row._rowIndex})" class="text-blue-600 hover:text-blue-800 p-2 rounded-full transition transform hover:scale-110"><i class="fas fa-edit"></i></button>${deleteBtn}</td>`;
      }
      html += `</tr>`;
    });
    html += `</tbody></table></div>`;
    div.innerHTML = html;
    setTimeout(() => {
        if ($.fn.DataTable.isDataTable('#dataTableID')) $('#dataTableID').DataTable().destroy();
        $('#dataTableID').DataTable({
            responsive: false, scrollX: true, language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json" },
            dom: '<"flex flex-col md:flex-row justify-between items-center mb-4 gap-4" <"flex items-center space-x-2"lB> f >rtip',
            buttons: [ { extend: 'excelHtml5', text: '<i class="fas fa-file-excel mr-1"></i> Excel', className: 'dt-button' }, { extend: 'print', text: '<i class="fas fa-print mr-1"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå / PDF', className: 'dt-button', autoPrint: true, customize: function(win) { $(win.document.body).css('font-family', 'Sarabun'); } } ]
        });
    }, 50);
  }

  function renderCards(menuItem, data) {
    const div = document.getElementById('card-area');
    div.innerHTML = '';
    if (!data || data.length === 0) { div.innerHTML = `<p class="col-span-3 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`; return; }
    data.forEach(row => {
      let cardHtml = '';
      const adminControls = (currentUser.role === 'admin') ? `<div class="flex space-x-2"><button onclick="editItem(${row._rowIndex})" class="text-gray-400 hover:text-blue-600 transition"><i class="fas fa-edit"></i></button><button onclick="deleteItem(${row._rowIndex})" class="text-gray-400 hover:text-red-600 transition"><i class="fas fa-trash"></i></button></div>` : '';
      if (menuItem.table === 'Setting') {
         cardHtml = `<div class="admin-card bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-md transition"><div class="flex justify-between items-start mb-3"><div class="flex items-center"><div class="p-2 bg-gray-100 rounded-lg text-gray-500 mr-3"><i class="fas fa-cog"></i></div><h3 class="font-bold text-gray-700 text-md">${row.setting_key}</h3></div>${adminControls}</div><p class="text-sm text-gray-500 mb-3 h-10 overflow-hidden line-clamp-2">${row.description || '-'}</p><div class="bg-gray-50 p-3 rounded-lg text-sm font-mono text-gray-700 break-all border border-gray-100">${row.setting_value}</div></div>`;
      }
      div.innerHTML += cardHtml;
    });
  }

  function addItem() {
    operationMode = 'add'; currentRowIndex = null;
    document.getElementById('modal-title').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà';
    document.getElementById('modal-icon').className = 'fas fa-plus text-blue-600';
    renderModalForm({});
    document.getElementById('edit-modal').classList.remove('hidden');
  }

  function editItem(rowIndex) {
    operationMode = 'edit'; currentRowIndex = rowIndex;
    const item = currentTableData.find(row => row._rowIndex === rowIndex);
    if (!item) return;
    document.getElementById('modal-title').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    document.getElementById('modal-icon').className = 'fas fa-edit text-blue-600';
    renderModalForm(item);
    document.getElementById('edit-modal').classList.remove('hidden');
  }
  
  function renderModalForm(itemData) {
    const formDiv = document.getElementById('modal-form-content');
    formDiv.innerHTML = '';
    const config = COLUMN_CONFIG[currentMenu.table] || (currentTableData.length > 0 ? Object.keys(currentTableData[0]).filter(k => k !== '_rowIndex').map(k => ({ key: k, label: k })) : []);
    config.forEach(f => {
      const val = itemData[f.key] || '';
      const isReadonly = (operationMode === 'edit' && f.readonly);
      const readonlyAttr = isReadonly ? 'disabled' : '';
      const bgClass = isReadonly ? 'bg-gray-100 text-gray-500' : 'bg-white';
      formDiv.innerHTML += `<div class="mb-3"><label class="block text-sm font-medium text-gray-700 mb-1">${f.label}</label>`;
      if (currentMenu.table === 'Documents' && (f.key === 'category' || f.key === 'target_role')) {
           const options = f.key === 'category' ? ['‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£', '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á', '‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠', '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á', '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ'] : ['all', 'school', 'admin'];
           let selectHtml = `<select id="input-${f.key}" ${readonlyAttr} class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition ${bgClass}">`;
           selectHtml += `<option value="" disabled ${!val ? 'selected' : ''}>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>`;
           options.forEach(opt => { selectHtml += `<option value="${opt}" ${val === opt ? 'selected' : ''}>${opt}</option>`; });
           selectHtml += `</select>`; formDiv.innerHTML += selectHtml;
      } 
      else if (currentMenu.table === 'Users' && (f.key === 'role' || f.key === 'status')) {
           let options = f.key === 'role' ? ['admin', 'school', 'supervisor'] : ['Active', 'Inactive'];
           let selectHtml = `<select id="input-${f.key}" ${readonlyAttr} class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition ${bgClass}">`;
           options.forEach(opt => { const isSelected = String(val) === String(opt) ? 'selected' : ''; selectHtml += `<option value="${opt}" ${isSelected}>${opt}</option>`; });
           selectHtml += `</select>`; formDiv.innerHTML += selectHtml;
      }
      else {
           formDiv.innerHTML += `<input type="text" id="input-${f.key}" value="${val}" ${readonlyAttr} class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition ${bgClass}">`;
      }
      formDiv.innerHTML += `</div>`;
    });
  }

  function saveData() {
    closeModal();
    let formData = {};
    const config = COLUMN_CONFIG[currentMenu.table] || (currentTableData.length > 0 ? Object.keys(currentTableData[0]).filter(k => k !== '_rowIndex').map(k => ({ key: k })) : []);
    config.forEach(f => { const el = document.getElementById(`input-${f.key}`); if (el && (operationMode === 'add' || !el.disabled)) formData[f.key] = el.value; });

    if (operationMode === 'edit') {
        const index = currentTableData.findIndex(r => r._rowIndex === currentRowIndex);
        if (index !== -1) Object.assign(currentTableData[index], formData);
        processAndRender(currentTableData, currentMenu);
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
        Toast.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' });
    } else {
        toggleLoader(true); 
    }

    DATA_CACHE[currentMenu.table] = currentTableData;

    const backendFunc = (operationMode === 'add') ? google.script.run.apiAddData(currentMenu.table, formData) 
                                                  : google.script.run.apiUpdateDataByRow(currentMenu.table, currentRowIndex, formData);
    backendFunc.withSuccessHandler(res => {
      if (operationMode === 'add') {
          loadContent(currentMenu, true); 
          Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false });
      }
    }).withFailureHandler(err => {
        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        loadContent(currentMenu, true); 
    });
  }

  function deleteItem(rowIndex) {
    Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?', text: "‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' }).then((result) => {
      if (result.isConfirmed) {
        currentTableData = currentTableData.filter(r => r._rowIndex !== rowIndex);
        DATA_CACHE[currentMenu.table] = currentTableData;
        processAndRender(currentTableData, currentMenu);
        
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
        Toast.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß' });

        google.script.run.withSuccessHandler(res => {}).withFailureHandler(err => { Swal.fire('Error', '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); loadContent(currentMenu, true); }).apiDeleteDataByRow(currentMenu.table, rowIndex);
      }
    });
  }

  function closeModal() { document.getElementById('edit-modal').classList.add('hidden'); }
  function toggleLoader(show) { const el = document.getElementById('loader'); show ? el.classList.remove('hidden') : el.classList.add('hidden'); }
  function refreshData() { if(currentMenu) loadContent(currentMenu, true); }
</script>
